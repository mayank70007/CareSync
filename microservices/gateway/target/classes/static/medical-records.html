<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Medical Records</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" href="data:," />
  <script src="/js/auth.js"></script>
  <style>
    textarea { width: 100%; min-height: 5rem; }
  </style>
  </head>
  <body>
    <main class="card">
      <div class="row"><h1>Medical Records</h1>
        <nav class="row" style="gap:.5rem">
          <a class="tile" href="/">Home</a>
          <a class="tile" id="loginLink" href="/login.html">Login</a>
          <button id="logoutBtn" class="tile" style="display:none">Logout</button>
        </nav>
      </div>

      <section class="section" id="createSection">
        <h2>Create Record</h2>
        <form id="recForm">
          <div class="row">
            <div><label>Patient ID<input name="patientId" type="number" required /></label></div>
            <div><label>Diagnosis<textarea name="diagnosis" required></textarea></label></div>
            <div><label>Treatment<textarea name="treatment" required></textarea></label></div>
            <div><label>Date<input name="recordDate" type="date" required /></label></div>
          </div>
          <button class="primary" type="submit">Save</button>
          <span id="recMsg" class="note"></span>
        </form>
      </section>

      <section class="section" id="listSection">
        <h2>Records</h2>
        <div class="list">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Patient ID</th>
                <th>Diagnosis</th>
                <th>Treatment</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="recBody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      function renderAuthUI(){
        renderAuthNav('loginLink','logoutBtn');
        const role = getRole();
        const isAdmin = role==='ROLE_ADMIN';
        const isDoctor = role==='ROLE_DOCTOR';
        document.getElementById('createSection').style.display = (isAdmin || isDoctor) ? '' : 'none';
      }
      document.getElementById('logoutBtn').addEventListener('click', logoutAndGoLogin);

      async function loadRecords(){
        ensureLogin(['ROLE_ADMIN','ROLE_DOCTOR','ROLE_PATIENT']);
        const res = await authFetch('/medicalrecord', { headers: { 'Accept':'application/json' } });
        const data = await res.json();
        const tbody = document.getElementById('recBody');
        tbody.innerHTML = '';
        data.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.id ?? ''}</td>
            <td>${r.patientId ?? ''}</td>
            <td>${r.diagnosis ?? ''}</td>
            <td>${r.treatment ?? ''}</td>
            <td>${r.recordDate ?? ''}</td>
            <td><button data-id="${r.id}" class="danger">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button.danger').forEach(btn =>
          btn.addEventListener('click', async (e)=>{
            const id = e.currentTarget.getAttribute('data-id');
            if(!id) return;
            if(!confirm('Delete record #' + id + '?')) return;
            const res = await authFetch('/medicalrecord/' + id, { method: 'DELETE' });
            if(res.ok) loadRecords();
          })
        );
      }

      document.getElementById('recForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const q = new URLSearchParams(fd);
        const msg = document.getElementById('recMsg');
        msg.textContent = 'Saving...';
        const res = await authFetch('/medicalrecord?' + q.toString(), { method: 'POST', headers:{'Accept':'application/json'} });
        if(!res.ok){ msg.textContent = 'Error: ' + (await res.text()); }
        else { msg.textContent = 'Saved'; e.target.reset(); loadRecords(); }
      });

      window.addEventListener('storage', ()=>{ renderAuthUI(); loadRecords(); });
      renderAuthUI();
      loadRecords();
    </script>
  </body>
  </html>
