<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctors</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" href="data:," />
  <script src="/js/auth.js"></script>
</head>
<body>
  <main class="card">
    <div class="row"><h1>Doctors</h1>
      <nav class="row" style="gap:.5rem">
        <a class="tile" href="/">Home</a>
        <a class="tile" id="loginLink" href="/login.html">Login</a>
        <button id="logoutBtn" class="tile" style="display:none">Logout</button>
      </nav>
    </div>

  <section class="section" id="manageCreateSection">
      <h2>Add Doctor</h2>
      <form id="doctorForm">
        <div class="row">
          <div><label>Username<input name="username" required /></label></div>
          <div><label>Password<input name="password" type="password" required /></label></div>
        </div>
        <div class="row">
          <div><label>Name<input name="name" required /></label></div>
          <div><label>Specialization<input name="specialization" required /></label></div>
        </div>
        <div class="row">
          <div><label>Phone<input name="phone" required /></label></div>
          <div><label>Email<input name="email" type="email" required /></label></div>
        </div>
        <button class="primary" type="submit">Create</button>
        <span id="doctorMsg" class="note"></span>
      </form>
      <div class="note" id="doctorCreds" style="display:none;margin-top:.5rem">
        <div class="row"><strong>Username:</strong> <span id="docCredUsername"></span></div>
        <div class="row"><strong>Password:</strong> <span id="docCredPassword"></span></div>
        <button class="tile" id="copyDocCreds">Copy credentials</button>
      </div>
    </section>

  <section class="section" id="manageListSection">
      <h2>All Doctors</h2>
      <div class="list">
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Specialization</th><th>Phone</th><th>Email</th><th>Actions</th></tr></thead>
          <tbody id="doctorsBody"></tbody>
        </table>
      </div>
    </section>

    <section class="section" id="doctorSelfSection" style="display:none">
      <h2>My Profile</h2>
      <div id="myProfile"></div>
      <h3 style="margin-top:1rem">My Patients</h3>
      <div class="list">
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Age</th><th>Gender</th><th>Phone</th></tr></thead>
          <tbody id="myPatientsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    function renderAuthUI(){
      renderAuthNav('loginLink','logoutBtn');
      const role = getRole();
  const isAdmin = role==='ROLE_ADMIN';
  const isDoctor = role==='ROLE_DOCTOR';
  document.getElementById('manageCreateSection').style.display = isAdmin ? '' : 'none';
  document.getElementById('manageListSection').style.display = isAdmin ? '' : 'none';
  document.getElementById('doctorSelfSection').style.display = isDoctor ? '' : 'none';
    }
    document.getElementById('logoutBtn').addEventListener('click', logoutAndGoLogin);
  const api = (p, init) => authFetch(p, { ...(init||{}), headers: { 'Accept': 'application/json','Content-Type':'application/json', ...(init&&init.headers)||{} } });

    async function loadDoctors(){
      ensureLogin(['ROLE_ADMIN','ROLE_DOCTOR']);
      const roleNow = getRole();
      const res = await api('/doctor');
      const data = await res.json();
      const tbody = document.getElementById('doctorsBody');
      tbody.innerHTML = '';
      const canDelete = roleNow==='ROLE_ADMIN';
      data.forEach(d => {
        const tr = document.createElement('tr');
        const actions = canDelete ? `<button data-id="${d.id}" class="danger">Delete</button>` : '';
        tr.innerHTML = `<td>${d.id??''}</td><td>${d.name??''}</td><td>${d.specialization??''}</td><td>${d.phone??''}</td><td>${d.email??''}</td><td>${actions}</td>`;
        tbody.appendChild(tr);
      });
      if(canDelete){
        tbody.querySelectorAll('button.danger').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          if(!id) return;
          if(!confirm('Delete doctor #' + id + '?')) return;
          try{
            const res = await fetch('/doctor/' + id, { method:'DELETE', headers: authHeaders() });
            if(!res.ok){
              alert('Delete failed: ' + (await res.text()));
            } else {
              await loadDoctors();
            }
          }catch(err){
            alert('Network error');
          }
        }));
      }
    }

    document.getElementById('doctorForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      const enteredUsername = body.username;
      const enteredPassword = body.password;
      const msg = document.getElementById('doctorMsg');
      msg.textContent = 'Saving...';
      try {
  const res = await authFetch('/doctor', { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(body)});
        if(!res.ok){
          const text = await res.text();
          msg.textContent = `Error: ${text}`;
        }else{
          const data = await res.json();
          msg.textContent = 'Saved';
          e.target.reset();
          await loadDoctors();
          // Show credentials that were used
          if(enteredUsername && enteredPassword){
            document.getElementById('docCredUsername').textContent = enteredUsername;
            document.getElementById('docCredPassword').textContent = enteredPassword;
            document.getElementById('doctorCreds').style.display = '';
          }
        }
      } catch(err){
        msg.textContent = 'Network error';
      }
    });

    document.getElementById('copyDocCreds').addEventListener('click', async ()=>{
      const u = document.getElementById('docCredUsername').textContent;
      const p = document.getElementById('docCredPassword').textContent;
      try{ await navigator.clipboard.writeText(`Username: ${u}\nPassword: ${p}`); }catch{}
    });

    async function loadMyDoctorArea(){
      ensureLogin(['ROLE_ADMIN','ROLE_DOCTOR','ROLE_PATIENT']);
      if(getRole() !== 'ROLE_DOCTOR') return;
      try{
        const res = await authFetch('/doctor/me', { headers:{'Accept':'application/json'} });
        const box = document.getElementById('myProfile');
        if(!res.ok){
          box.textContent = 'Profile not found.';
        } else {
          const profile = await res.json();
          if(profile){
            box.innerHTML = `<div><strong>${profile.name||''}</strong></div>
                             <div>${profile.specialization||''}</div>
                             <div>${profile.phone||''}</div>
                             <div>${profile.email||''}</div>`;
          }
        }
      }catch{}

      try{
        const res = await authFetch('/doctor/my/patients', { headers:{'Accept':'application/json'} });
        if(!res.ok) return;
        const data = await res.json();
        const tbody = document.getElementById('myPatientsBody');
        tbody.innerHTML = '';
        data.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.id??''}</td><td>${p.name??''}</td><td>${p.age??''}</td><td>${p.gender??''}</td><td>${p.phone??''}</td>`;
          tbody.appendChild(tr);
        });
      }catch{}
    }

  window.addEventListener('storage', ()=>{ renderAuthUI(); loadDoctors(); loadMyDoctorArea(); });
  renderAuthUI();
  loadDoctors();
  loadMyDoctorArea();
  </script>
</body>
</html>
