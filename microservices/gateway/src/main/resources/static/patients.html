<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patients</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" href="data:," />
  <script src="/js/auth.js"></script>
</head>
<body>
  <main class="card">
    <div class="row"><h1>Patients</h1>
      <nav class="row" style="gap:.5rem">
        <a class="tile" href="/">Home</a>
        <a class="tile" id="loginLink" href="/login.html">Login</a>
        <button id="logoutBtn" class="tile" style="display:none">Logout</button>
      </nav>
    </div>

    <section class="section">
      <h2>Add Patient</h2>
      <form id="patientForm">
        <div class="row">
          <div><label>Username<input name="username" required /></label></div>
          <div><label>Password<input name="password" type="password" required /></label></div>
        </div>
        <div class="row">
          <div><label>Name<input name="name" required /></label></div>
          <div><label>Age<input name="age" type="number" min="0" required /></label></div>
          <div><label>Gender<select name="gender"><option>Male</option><option>Female</option><option>Other</option></select></label></div>
        </div>
        <div class="row">
          <div><label>Phone<input name="phone" required /></label></div>
          <div><label>Address<input name="address" /></label></div>
        </div>
        <button class="primary" type="submit">Create</button>
        <span id="patientMsg" class="note"></span>
      </form>
    </section>

    <section class="section">
      <h2>All Patients</h2>
      <div class="list">
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Age</th><th>Gender</th><th>Phone</th><th>Address</th><th>Actions</th></tr></thead>
          <tbody id="patientsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="credModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center">
    <div class="card" style="max-width:480px">
      <h3>Patient account created</h3>
      <p>Share these credentials with the patient:</p>
      <div class="row"><strong>Username:</strong> <span id="credUsername"></span></div>
      <div class="row"><strong>Password:</strong> <span id="credPassword"></span></div>
      <div class="row" style="gap:.5rem;margin-top:1rem">
        <button id="copyCreds" class="tile">Copy</button>
        <button id="closeCreds" class="tile">Close</button>
      </div>
    </div>
  </div>

  <script>
    function renderAuthUI(){
      renderAuthNav('loginLink','logoutBtn');
      const canManage = ['ROLE_ADMIN','ROLE_DOCTOR'].includes(getRole());
      document.getElementById('patientForm').closest('.section').style.display = canManage ? '' : 'none';
    }
    document.getElementById('logoutBtn').addEventListener('click', logoutAndGoLogin);
  const api = (p, init) => authFetch(p, { ...(init||{}), headers: { 'Accept': 'application/json','Content-Type':'application/json', ...(init&&init.headers)||{} } });

    async function loadPatients(){
      ensureLogin(['ROLE_ADMIN','ROLE_DOCTOR']);
      const roleNow = getRole();
      const res = await api('/patient');
      const data = await res.json();
      const tbody = document.getElementById('patientsBody');
      tbody.innerHTML = '';
      const canDelete = ['ROLE_ADMIN','ROLE_DOCTOR'].includes(roleNow);
      data.forEach(p => {
        const tr = document.createElement('tr');
        const actions = canDelete ? `<button data-id="${p.id}" class="danger">Delete</button>` : '';
        tr.innerHTML = `<td>${p.id??''}</td><td>${p.name??''}</td><td>${p.age??''}</td><td>${p.gender??''}</td><td>${p.phone??''}</td><td>${p.address??''}</td><td>${actions}</td>`;
        tbody.appendChild(tr);
      });
      if(canDelete){
        tbody.querySelectorAll('button.danger').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          if(!id) return;
          if(!confirm('Delete patient #' + id + '?')) return;
          try{
            const res = await fetch('/patient/' + id, { method:'DELETE', headers: authHeaders() });
            if(!res.ok){
              alert('Delete failed: ' + (await res.text()));
            } else {
              await loadPatients();
            }
          }catch(err){
            alert('Network error');
          }
        }));
      }
    }

    document.getElementById('patientForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = Object.fromEntries(fd.entries());
      body.age = Number(body.age);
      const enteredUsername = body.username;
      const enteredPassword = body.password;
      const msg = document.getElementById('patientMsg');
      msg.textContent = 'Saving...';
      try {
  const res = await authFetch('/patient', { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(body)});
        if(!res.ok){
          const text = await res.text();
          msg.textContent = `Error: ${text}`;
        }else{
          const data = await res.json();
          msg.textContent = 'Saved';
          e.target.reset();
          const modal = document.getElementById('credModal');
          document.getElementById('credUsername').textContent = enteredUsername || '';
          document.getElementById('credPassword').textContent = enteredPassword || '';
          modal.style.display = 'flex';
          await loadPatients();
        }
      } catch(err){
        msg.textContent = 'Network error';
      }
    });

  document.getElementById('closeCreds').addEventListener('click', ()=>{
    document.getElementById('credModal').style.display = 'none';
  });
  document.getElementById('copyCreds').addEventListener('click', async ()=>{
    const u = document.getElementById('credUsername').textContent;
    const p = document.getElementById('credPassword').textContent;
    try{ await navigator.clipboard.writeText(`Username: ${u}\nPassword: ${p}`); }catch{}
  });

  window.addEventListener('storage', renderAuthUI);
  renderAuthUI();
    loadPatients();
  </script>
</body>
</html>
